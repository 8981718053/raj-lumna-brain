<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lumna Search â€” Raj & Lumna</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  :root{--bg1:#071025;--bg2:#081428;--accent:#ff4d8b;--accent2:#6ea8ff;--muted:rgba(255,255,255,0.65);--card:rgba(255,255,255,0.03);--radius:14px}
  *{box-sizing:border-box;font-family:Inter,system-ui,Arial;color:#eaf2ff} body{margin:0;min-height:100vh;background:radial-gradient(900px 400px at 10% 8%, rgba(14,21,44,0.6), transparent), linear-gradient(160deg,var(--bg1),var(--bg2));}
  .wrap{max-width:1200px;margin:22px auto;padding:14px;display:grid;grid-template-columns:1fr 420px;gap:16px}
  @media(max-width:980px){.wrap{grid-template-columns:1fr}.side{order:2}}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#ffd1f0);display:flex;align-items:center;justify-content:center;color:#081028;font-weight:800}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03)}
  .controls{display:flex;gap:10px}
  input.search{flex:1;padding:12px;border-radius:12px;border:none;background:var(--card);color:inherit;font-size:15px;outline:none}
  .types{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
  .type-btn{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);cursor:pointer}
  .type-btn.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#081028;border:none;font-weight:600}
  .result{padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);margin-bottom:10px}
  .r-title a{color:#eaf2ff;text-decoration:none}
  .r-title a:hover{text-decoration:underline}
  .preview-pane{margin-top:12px;padding:12px;border-radius:10px;background:rgba(255,255,255,0.01);max-height:400px;overflow:auto}
  .chat{max-height:60vh;overflow:auto;padding-right:6px}
  .bubble{padding:8px 10px;border-radius:12px;margin:8px 0;font-size:14px}
  .bubble.ai{background:rgba(110,168,255,0.08)}
  .bubble.user{background:rgba(255,77,139,0.06);align-self:flex-end}
  .mini{display:flex;gap:8px;margin-top:8px}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#081028;border:none}
  .loader{display:inline-block;width:14px;height:14px;border-radius:50%;border:3px solid rgba(255,255,255,0.12);border-top-color:var(--accent2);animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
  <div class="wrap">
    <div>
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
        <div class="logo">L</div>
        <div>
          <div style="font-weight:700">Lumna Search</div>
          <div style="font-size:13px;color:var(--muted)">Scientific smart search â€” brain in Worker</div>
        </div>
      </div>

      <div class="card">
        <div class="controls">
          <input id="q" class="search" placeholder="Search web, image, video, audio, code, medicine..." />
          <button id="searchBtn" class="btn primary">Search</button>
        </div>

        <div class="types" id="types">
          <button class="type-btn active" data-type="web">Web</button>
          <button class="type-btn" data-type="image">Image</button>
          <button class="type-btn" data-type="video">Video</button>
          <button class="type-btn" data-type="audio">Audio</button>
          <button class="type-btn" data-type="code">Code</button>
          <button class="type-btn" data-type="medicine">Medicine</button>
        </div>

        <div id="results" style="margin-top:12px"></div>

        <div id="preview" class="preview-pane" style="display:none"></div>

        <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
          <div style="padding:8px;border-radius:10px;background:rgba(255,255,255,0.02)">ðŸ§  <span id="brainState">idle</span></div>
          <div style="flex:1"></div>
          <button id="clearBtn" class="btn">Clear</button>
        </div>
      </div>
    </div>

    <aside class="side">
      <div class="card" style="display:flex;flex-direction:column;height:100%">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <div style="width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#ffd1f0,#ffb3db);display:flex;align-items:center;justify-content:center;color:#081028;font-weight:700">L</div>
          <div>
            <div style="font-weight:700">Lumna Analyzer</div>
            <div style="font-size:12px;color:var(--muted)">Explanation & pattern signals</div>
          </div>
        </div>

        <div id="chat" class="chat">
          <div class="bubble ai">Hello â€” I'm Lumna. Ask a query to analyze & rank results.</div>
        </div>

        <div class="mini">
          <input id="mini" placeholder="Quick note..." style="flex:1;padding:8px;border-radius:10px;border:none;background:rgba(255,255,255,0.02);color:inherit"/>
          <button id="noteBtn" class="btn">Save</button>
        </div>
      </div>
    </aside>
  </div>

<script>
const WORKER = "https://lumna-work.r-8981718053.workers.dev/";
let currentType = 'web';
const types = document.querySelectorAll('.type-btn');
types.forEach(t=> t.addEventListener('click', ()=>{
  types.forEach(x=>x.classList.remove('active')); t.classList.add('active'); currentType = t.dataset.type; document.getElementById('brainState').innerText = 'mode:'+currentType;
}));

document.getElementById('searchBtn').addEventListener('click', doSearch);
document.getElementById('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter') doSearch(); });
document.getElementById('clearBtn').addEventListener('click', ()=>{ document.getElementById('results').innerHTML=''; document.getElementById('preview').style.display='none'; });

function capChat(){
  const chat = document.getElementById('chat');
  const msgs = chat.querySelectorAll('.bubble');
  // keep last 6 messages (remove older)
  while(msgs.length > 6){
    msgs[0].remove();
  }
}
function addChat(text, who='ai'){
  const chat = document.getElementById('chat');
  const d = document.createElement('div'); d.className='bubble '+who; d.innerText=text;
  chat.appendChild(d); chat.scrollTop = chat.scrollHeight; capChat();
}

function makeResultCard(item){
  const r = document.createElement('div'); r.className='result';
  r.innerHTML = `
    <div class="r-title"><a href="#" data-url="${item.url}">${escapeHtml(item.title || item.url)}</a></div>
    <div class="r-url">${escapeHtml(item.url)}</div>
    <div class="r-snippet">${escapeHtml(item.snippet || '')}</div>
    <div style="display:flex;gap:10px;align-items:center;margin-top:8px">
      <div style="background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;font-size:12px">score ${item.score ?? ''}</div>
      <div style="flex:1"></div>
      <div style="font-size:12px;color:var(--muted)">${item.engine||''}</div>
    </div>
  `;
  // click on title => preview
  r.querySelector('a').addEventListener('click', async (ev)=>{
    ev.preventDefault();
    const url = ev.target.dataset.url;
    await showPreview(url);
  });
  return r;
}

function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

async function showPreview(url){
  const preview = document.getElementById('preview');
  preview.style.display = 'block';
  preview.innerHTML = '<div style="display:flex;gap:8px;align-items:center"><div class="loader"></div><div>Loading previewâ€¦</div></div>';
  try {
    const resp = await fetch(WORKER + '?fetch_page=' + encodeURIComponent(url));
    if (!resp.ok) throw new Error('preview failed '+resp.status);
    // Worker returns sanitized HTML: we insert it inside preview safely
    const html = await resp.text();
    // Insert using innerHTML â€” content from our Worker is sanitized by Worker (scripts removed).
    preview.innerHTML = html;
    addChat('Preview loaded for ' + url, 'ai');
  } catch(err){
    preview.style.display='none';
    // fallback: open in new tab
    window.open(url,'_blank');
    addChat('Preview failed â€” opened in new tab.', 'ai');
  }
}

/* main search */
async function doSearch(){
  const q = document.getElementById('q').value.trim();
  if(!q) return;
  document.getElementById('results').innerHTML = `<div style="padding:12px" class="result"><div style="display:flex;gap:8px;align-items:center"><div class="loader"></div><div>Fetching resultsâ€¦</div></div></div>`;
  document.getElementById('brainState').innerText = 'thinking';
  addChat('â€¦thinking on: "'+q+'"','ai');

  try {
    const resp = await fetch(WORKER + '?q=' + encodeURIComponent(q) + '&type=' + encodeURIComponent(currentType));
    if (!resp.ok) throw new Error('Worker error '+resp.status);
    const data = await resp.json();
    document.getElementById('results').innerHTML = '';
    document.getElementById('preview').style.display='none';

    if (data && Array.isArray(data.results) && data.results.length>0) {
      data.results.forEach(item=>{
        document.getElementById('results').appendChild(makeResultCard(item));
      });
    } else {
      // fallback: external search link
      const external = document.createElement('div'); external.className='result';
      external.innerHTML = `<div style="font-weight:700">No internal results</div><div style="margin-top:8px"><a href="${externalSearchURL(q,currentType)}" target="_blank" class="btn primary">Open external ${currentType} search</a></div>`;
      document.getElementById('results').appendChild(external);
    }

    addChat('Analyzed query: "'+q+'" â€” brain updated.','ai');
    document.getElementById('brainState').innerText = 'idle';
  } catch (err) {
    document.getElementById('results').innerHTML = '';
    const e = document.createElement('div'); e.className='result'; e.innerText = 'Error: '+err.message;
    document.getElementById('results').appendChild(e);
    document.getElementById('brainState').innerText = 'error';
    addChat('Error fetching: '+err.message,'ai');
  }
}

function externalSearchURL(q,type){
  const qE = encodeURIComponent(q);
  if(type==='web') return `https://www.bing.com/search?q=${qE}`;
  if(type==='image') return `https://www.bing.com/images/search?q=${qE}`;
  if(type==='video') return `https://www.youtube.com/results?search_query=${qE}`;
  if(type==='audio') return `https://soundcloud.com/search?q=${qE}`;
  if(type==='code') return `https://github.com/search?q=${qE}`;
  if(type==='medicine') return `https://pubmed.ncbi.nlm.nih.gov/?term=${qE}`;
  return `https://www.bing.com/search?q=${qE}`;
}

/* notes */
document.getElementById('noteBtn').addEventListener('click', ()=>{
  const v = document.getElementById('mini').value.trim();
  if(!v) return;
  const notes = JSON.parse(localStorage.getItem('rl_notes')||'[]');
  notes.push({t:Date.now(), text:v});
  localStorage.setItem('rl_notes', JSON.stringify(notes));
  addChat('Saved note: '+v,'user');
  document.getElementById('mini').value='';
});

/* focus */
document.getElementById('q').focus();
</script>
</body>
</html>
